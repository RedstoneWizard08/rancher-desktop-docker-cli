name: Build binaries and create a draft release

on:
  push:
    tags: ['*']

defaults:
  run:
    shell: bash

env:
  DOCKER_CLI_REF: v20.10.16

jobs:
  build:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest

    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - uses: actions/checkout@v2
      with:
        repository: docker/cli
        ref: ${{ env.DOCKER_CLI_REF }}
        persist-credentials: false

    # Workaround the "dirty version bug" in https://github.com/docker/cli/pull/3349
    # The assignment is from https://github.com/docker/cli/blob/e57b5f78de635e6e2b688686d10b830c4747c4dc/scripts/build/.variables#L7
    - name: Override CLI Version
      run: |
        VERSION=${VERSION:-$(git describe --match 'v[0-9]*' --dirty='.m' --always --tags | sed 's/^v//' 2>/dev/null)}
        if [ -n "$VERSION" ] ; then
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
        fi

    - name: Build darwin amd64
      uses: docker/bake-action@v1
      with:
        set: "binary.platform=darwin/amd64"

    - name: Build darwin arm64
      uses: docker/bake-action@v1
      with:
        set: "binary.platform=darwin/arm64"

    - name: Build linux
      uses: docker/bake-action@v1
      with:
       set: "binary.platform=linux/amd64"

    - name: Build on Windows
      uses: docker/bake-action@v1
      with:
        set: "binary.platform=windows/amd64"

    - name:  Calculate Checksums
      working-directory: "./build"
      run: sha256sum docker-* > sha256sum.txt

    - uses: actions/upload-artifact@v2
      name: Upload Darwin amd64 artifact
      with:
        name: docker-darwin-amd64
        path: ./build/docker-darwin-amd64
        if-no-files-found: error

    - uses: actions/upload-artifact@v2
      name: Upload Darwin arm64 artifact
      with:
        name: docker-darwin-arm64
        path: ./build/docker-darwin-arm64
        if-no-files-found: error

    - uses: actions/upload-artifact@v2
      name: Upload Linux artifact
      with:
        name: docker-linux-amd64
        path: ./build/docker-linux-amd64
        if-no-files-found: error

    - uses: actions/upload-artifact@v2
      name: Upload Windows artifact
      with:
        name: docker-windows-amd64
        path: ./build/docker-windows-amd64.exe
        if-no-files-found: error

    - uses: actions/upload-artifact@v2
      name: Upload checksums
      with:
        name: sha256sum.txt
        path: ./build/sha256sum.txt
        if-no-files-found: error

    - name: Create draft release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ env.DOCKER_CLI_REF }}
      run: >-
        gh release create
        "${ref}"
        ./build/docker-*
        ./build/sha256sum.txt
        --draft
        --title "${tag}"
        --repo ${{ github.repository }}
